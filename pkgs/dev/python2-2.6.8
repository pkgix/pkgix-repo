# Based on: http://aur.archlinux.org/packages/py/python26/PKGBUILD

version=2.6.8
description="The Python 2 interpreter"
depends=("dev/gdbm" "dev/readline")
website="http://www.python.org"
license=('PSF')

_pybasever="${version%.*}"

isinstalled() {
	python2 --version 2>&1 | grep -q "$version" &> /dev/null
}

iscompat() {
	return 0
}

build() {
	fetch_extract \
		"http://www.python.org/ftp/python/${version}/Python-${version}.tar.bz2" \
		"c34036718ee1f091736677f543bc7960861cf9fcbea77d49572b59f7f1ab3c3f"

	cd "Python-${version}"
		
	fetch \
		"http://bugs.python.org/file14933/python-support_bdb-4.8.patch" \
		"2a4b9d85c6b616e5df30d42d0890865f2c2103e8d7d5d7d77c092f1f7aff1458"

	fetch \
		"$repo/../support/patches/dev/python-2.6-internal-expat.patch" \
		"c99c8305180083e40aff789e3a3c74ed375037fdc7bd02876270b09274033069"

	patch -Np0 -i python-support_bdb-4.8.patch
	patch -Np0 -i python-2.6-internal-expat.patch

	LDFLAGS="-Wl,-rpath=$LD_RUN_PATH" ./configure --prefix="${prefix}" --enable-shared --with-threads --enable-ipv6 \
                --enable-unicode=ucs4 --with-system-ffi

	case "$ostype" in
		*linux*)
			make MACHDEP=linux2
			;;
		*)
			make
			;;
	esac
}

installenv() {
	cd "Python-${version}"
	make DESTDIR="${destdir}" altinstall maninstall

	ln -sf python${_pybasever} "${destdir}/${prefix}/bin/python2"

	ln -sf ../../libpython${_pybasever}.so \
		"${destdir}/${prefix}/lib/python${_pybasever}/config/libpython${_pybasever}.so"

	mv "${destdir}/${prefix}/bin/smtpd.py" "${destdir}/${prefix}/lib/python${_pybasever}/"

	# fix conflicts with python
	mv "${destdir}/${prefix}"/bin/idle{,${_pybasever}}
	mv "${destdir}/${prefix}"/bin/pydoc{,${_pybasever}}
	mv "${destdir}/${prefix}"/bin/2to3{,-${_pybasever}}
	mv "${destdir}/${prefix}"/share/man/man1/python{.1,${_pybasever}.1}

	# clean up #!s
	find "${destdir}/${prefix}/lib/python${_pybasever}/" -name '*.py' | \
		xargs sed -i "s|#[ ]*![ ]*/usr/bin/env python$|#!/usr/bin/env python${_pybasever}|"
}

# vim: set ft=sh :
